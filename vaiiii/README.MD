# NomaTV - Sistema de Gerenciamento IPTV

## VisÃ£o Geral

O **NomaTV** Ã© um sistema completo de gerenciamento para provedores de IPTV, desenvolvido em PHP com SQLite. Oferece uma interface web moderna para administraÃ§Ã£o de revendedores, provedores, clientes e controle financeiro.

## Arquitetura do Sistema

### Estrutura HierÃ¡rquica
```
Administrador
â”œâ”€â”€ Master Revendedor
â”‚   â””â”€â”€ Sub-Revendedor
â”‚       â””â”€â”€ Cliente Final
â””â”€â”€ Master Revendedor
    â””â”€â”€ Sub-Revendedor
        â””â”€â”€ Cliente Final
```

### Componentes Principais

#### Backend (PHP + SQLite)
- **API RESTful** para todas as operaÃ§Ãµes
- **AutenticaÃ§Ã£o baseada em sessÃ£o**
- **Controle de permissÃµes hierÃ¡rquico**
- **Banco de dados SQLite** para persistÃªncia

#### Frontend (HTML/CSS/JavaScript)
- **Interface responsiva** com Bootstrap 5
- **SPA (Single Page Application)**
- **Dashboard interativo** com grÃ¡ficos
- **Gerenciamento completo** via modais

#### Servidor (Node.js)
- **Servidor proxy** para API PHP
- **Servidor estÃ¡tico** para arquivos frontend
- **CORS habilitado** para desenvolvimento

## Funcionalidades

### ğŸ‘¥ GestÃ£o de Revendedores
- Cadastro de revendedores (Admin, Master, Sub)
- Controle hierÃ¡rquico de permissÃµes
- DefiniÃ§Ã£o de planos e valores
- RelatÃ³rios de performance

### ğŸ–¥ï¸ GestÃ£o de Provedores
- Cadastro de servidores IPTV
- VinculaÃ§Ã£o a revendedores
- Monitoramento de status
- Controle de acesso

### ğŸ“º GestÃ£o de Ativos
- Controle de client_ids
- AtivaÃ§Ã£o/desativaÃ§Ã£o em lote
- Bloqueio de acesso
- HistÃ³rico de atividade

### ğŸ’° GestÃ£o Financeira
- Controle de receita por revendedor
- RelatÃ³rios financeiros
- PrevisÃµes e projeÃ§Ãµes
- HistÃ³rico de pagamentos

### ğŸ”’ SeguranÃ§a
- AlteraÃ§Ã£o segura de senhas
- VerificaÃ§Ã£o de forÃ§a de senha
- Logs de auditoria
- Controle de acesso por IP

### ğŸ“Š RelatÃ³rios e Analytics
- Dashboard executivo
- RelatÃ³rios financeiros
- AnÃ¡lise de crescimento
- MÃ©tricas de performance

## Estrutura do Banco de Dados

### Tabelas Principais

#### `revendedores`
```sql
CREATE TABLE revendedores (
    id_revendedor INTEGER PRIMARY KEY AUTOINCREMENT,
    nome TEXT NOT NULL,
    usuario TEXT UNIQUE NOT NULL,
    senha TEXT NOT NULL,
    master TEXT CHECK(master IN ('admin', 'sim', 'nao')) DEFAULT 'nao',
    plano TEXT,
    valor_ativo REAL,
    valor_mensal REAL,
    ativo INTEGER DEFAULT 1,
    criado_em DATETIME DEFAULT CURRENT_TIMESTAMP,
    atualizado_em DATETIME DEFAULT CURRENT_TIMESTAMP,
    parent_id INTEGER,
    ultra_master_id INTEGER,
    data_bloqueio DATETIME,
    logo_filename TEXT,
    FOREIGN KEY (parent_id) REFERENCES revendedores(id_revendedor)
);
```

#### `provedores`
```sql
CREATE TABLE provedores (
    id_provedor INTEGER PRIMARY KEY AUTOINCREMENT,
    nome TEXT NOT NULL,
    dns TEXT NOT NULL,
    usuario TEXT,
    senha TEXT,
    id_revendedor INTEGER NOT NULL,
    ativo INTEGER DEFAULT 1,
    criado_em DATETIME DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (id_revendedor) REFERENCES revendedores(id_revendedor)
);
```

#### `client_ids`
```sql
CREATE TABLE client_ids (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    client_id TEXT UNIQUE NOT NULL,
    provedor_id INTEGER,
    id_revendedor INTEGER NOT NULL,
    usuario TEXT,
    senha TEXT,
    primeira_conexao DATETIME,
    ultima_atividade DATETIME,
    ativo INTEGER DEFAULT 1,
    bloqueado INTEGER DEFAULT 0,
    ip TEXT,
    user_agent TEXT,
    criado_em DATETIME DEFAULT CURRENT_TIMESTAMP,
    atualizado_em DATETIME DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (provedor_id) REFERENCES provedores(id_provedor),
    FOREIGN KEY (id_revendedor) REFERENCES revendedores(id_revendedor)
);
```

#### `auditoria`
```sql
CREATE TABLE auditoria (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    id_revendedor INTEGER,
    acao TEXT NOT NULL,
    detalhes TEXT,
    ip TEXT,
    user_agent TEXT,
    timestamp DATETIME DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (id_revendedor) REFERENCES revendedores(id_revendedor)
);
```

## Endpoints da API

### AutenticaÃ§Ã£o
- `POST /api/auth.php` - Login
- `POST /api/auth.php?action=logout` - Logout
- `GET /api/verificar_sessao.php` - Verificar sessÃ£o

### Revendedores
- `GET /api/revendedores.php` - Listar revendedores
- `POST /api/revendedores.php` - Criar revendedor
- `PUT /api/revendedores.php` - Atualizar revendedor
- `DELETE /api/revendedores.php?id={id}` - Excluir revendedor

### Provedores
- `GET /api/provedores.php` - Listar provedores
- `POST /api/provedores.php` - Criar provedor
- `PUT /api/provedores.php` - Atualizar provedor
- `DELETE /api/provedores.php?id={id}` - Excluir provedor

### Ativos (Client IDs)
- `GET /api/client_ids.php` - Listar ativos
- `PUT /api/client_ids.php` - Atualizar status
- `POST /api/client_ids.php?action=bulk` - AÃ§Ãµes em lote

### Financeiro
- `GET /api/financeiro.php` - Dados financeiros
- `GET /api/relatorios.php?tipo=financeiro` - RelatÃ³rios financeiros

### SeguranÃ§a
- `POST /api/seguranca.php?action=alterar_senha_admin` - Alterar senha
- `POST /api/seguranca.php?action=verificar_forca_senha` - Verificar forÃ§a
- `GET /api/seguranca.php` - Info do servidor

### RelatÃ³rios
- `GET /api/relatorios.php?tipo=dashboard` - Dashboard
- `GET /api/relatorios.php?tipo=revendedores` - Revendedores
- `GET /api/relatorios.php?tipo=provedores` - Provedores
- `GET /api/relatorios.php?tipo=atividade` - Atividade
- `GET /api/relatorios.php?tipo=crescimento` - Crescimento
- `GET /api/relatorios.php?tipo=completo` - RelatÃ³rio completo

### ConfiguraÃ§Ãµes
- `GET /api/configuracoes.php` - Buscar configuraÃ§Ãµes
- `PUT /api/configuracoes.php` - Salvar configuraÃ§Ãµes
- `POST /api/configuracoes.php?action=criar_backup` - Criar backup
- `GET /api/configuracoes.php?action=listar_backups` - Listar backups
- `GET /api/configuracoes.php?action=baixar_backup&filename={file}` - Baixar backup
- `POST /api/configuracoes.php?action=restaurar_backup` - Restaurar backup

### Branding
- `GET /api/branding/get.php` - Verificar logo
- `POST /api/branding/upload.php` - Upload de logo
- `DELETE /api/branding/delete.php` - Remover logo

### UtilitÃ¡rios
- `GET /api/ips.php` - Controle de IPs
- `GET /api/logs.php` - Logs de auditoria
- `GET /api/permissoes.php` - Gerenciar permissÃµes
- `GET /api/stats.php` - EstatÃ­sticas do dashboard
- `POST /api/cleanup.php` - Limpeza automÃ¡tica
- `GET /api/rede_revendedor.php` - Rede de revendedores

## InstalaÃ§Ã£o e ConfiguraÃ§Ã£o

### PrÃ©-requisitos
- PHP 7.4+
- SQLite3
- Node.js 14+
- Servidor web (Apache/Nginx)

### InstalaÃ§Ã£o

1. **Clone o repositÃ³rio**
```bash
git clone https://github.com/NomaTV/painel-backend-corrigido.git
cd painel-backend-corrigido
```

2. **Configure o banco de dados**
```bash
cd vaiiii/api
php db_installer.php
```

3. **Instale dependÃªncias do Node.js**
```bash
npm install
```

4. **Inicie o servidor**
```bash
node server.js
```

5. **Acesse o sistema**
```
http://localhost:3000
```

### ConfiguraÃ§Ã£o Inicial

ApÃ³s a instalaÃ§Ã£o, acesse com as credenciais padrÃ£o:
- **UsuÃ¡rio:** admin
- **Senha:** admin

âš ï¸ **Importante:** Altere a senha padrÃ£o imediatamente apÃ³s o primeiro acesso.

## Desenvolvimento

### Estrutura de Arquivos
```
vaiiii/
â”œâ”€â”€ admin.html              # Painel administrativo
â”œâ”€â”€ index.html              # PÃ¡gina de login
â”œâ”€â”€ sub_revendedor.html     # Painel sub-revendedor
â”œâ”€â”€ api.js                  # Cliente API JavaScript
â”œâ”€â”€ server.js               # Servidor Node.js
â”œâ”€â”€ README.MD               # Esta documentaÃ§Ã£o
â””â”€â”€ api/                    # Backend PHP
    â”œâ”€â”€ auth.php
    â”œâ”€â”€ revendedores.php
    â”œâ”€â”€ provedores.php
    â”œâ”€â”€ client_ids.php
    â”œâ”€â”€ financeiro.php
    â”œâ”€â”€ relatorios.php
    â”œâ”€â”€ seguranca.php
    â”œâ”€â”€ configuracoes.php
    â”œâ”€â”€ branding/
    â”‚   â”œâ”€â”€ get.php
    â”‚   â”œâ”€â”€ upload.php
    â”‚   â””â”€â”€ delete.php
    â”œâ”€â”€ config/
    â”‚   â”œâ”€â”€ database_sqlite.php
    â”‚   â””â”€â”€ api/
    â”‚       â”œâ”€â”€ config/
    â”‚       â”‚   â””â”€â”€ database_sqlite.php
    â”‚       â”œâ”€â”€ db.db
    â”‚       â”œâ”€â”€ helpers/
    â”‚       â”‚   â””â”€â”€ auth_helper.php
    â”‚       â””â”€â”€ logos/
    â”œâ”€â”€ ips.php
    â”œâ”€â”€ logs.php
    â”œâ”€â”€ permissoes.php
    â”œâ”€â”€ stats.php
    â”œâ”€â”€ validar_login.php
    â”œâ”€â”€ verificar_provedor.php
    â”œâ”€â”€ verificar_sessao.php
    â”œâ”€â”€ cleanup.php
    â”œâ”€â”€ rede_revendedor.php
    â””â”€â”€ db.db
```

### ConvenÃ§Ãµes de CÃ³digo

#### PHP
- PSR-12 para formataÃ§Ã£o
- Type hints quando possÃ­vel
- Tratamento de exceÃ§Ãµes
- Respostas JSON padronizadas

#### JavaScript
- ES6+ features
- Async/await para operaÃ§Ãµes assÃ­ncronas
- Tratamento de erros
- SeparaÃ§Ã£o de responsabilidades

#### HTML/CSS
- Bootstrap 5 para componentes
- CSS customizado mÃ­nimo
- Acessibilidade
- Responsividade

## SeguranÃ§a

### Medidas Implementadas
- **Hashing de senhas** com password_hash()
- **SessÃµes seguras** com regeneraÃ§Ã£o de ID
- **ValidaÃ§Ã£o de entrada** em todos os endpoints
- **Logs de auditoria** para todas as aÃ§Ãµes
- **Controle de permissÃµes** baseado em hierarquia
- **ProteÃ§Ã£o contra SQL Injection** com prepared statements
- **Headers de seguranÃ§a** (CORS, CSP)

### RecomendaÃ§Ãµes Adicionais
- Use HTTPS em produÃ§Ã£o
- Configure firewall
- Monitore logs regularmente
- FaÃ§a backups automÃ¡ticos
- Mantenha dependÃªncias atualizadas

## Monitoramento e ManutenÃ§Ã£o

### Limpeza AutomÃ¡tica
O sistema inclui um script de limpeza automÃ¡tica (`cleanup.php`) que:
- Inativa client_ids sem atividade hÃ¡ 7 dias
- Remove registros inativos hÃ¡ 60 dias
- Limpa logs antigos (90 dias)
- Remove arquivos Ã³rfÃ£os
- Otimiza o banco de dados

**RecomendaÃ§Ã£o:** Configure um cron job diÃ¡rio:
```bash
0 3 * * * /usr/bin/php /path/to/cleanup.php
```

### Backups
O sistema suporta backup e restauraÃ§Ã£o completos:
- Backup do banco de dados + arquivos
- RestauraÃ§Ã£o com verificaÃ§Ã£o de integridade
- Lista de backups disponÃ­veis
- Download de backups especÃ­ficos

### Logs e Auditoria
- Todas as aÃ§Ãµes sÃ£o registradas
- Filtros por usuÃ¡rio, aÃ§Ã£o e data
- ExportaÃ§Ã£o para anÃ¡lise
- RetenÃ§Ã£o configurÃ¡vel

## Troubleshooting

### Problemas Comuns

#### Erro de conexÃ£o com banco de dados
```
Verifique se o arquivo db.db existe e tem permissÃµes corretas
Execute: chmod 664 db.db
```

#### Erro 404 nas APIs
```
Verifique se o servidor Node.js estÃ¡ rodando
Verifique se as URLs estÃ£o corretas
```

#### Problemas de CORS
```
Verifique se o servidor permite origens corretas
Configure headers adequados
```

#### Erro de upload de logo
```
Verifique permissÃµes da pasta uploads/logos/
Verifique tamanho e formato do arquivo
```

### Debug Mode
Para ativar o modo debug, adicione ao `server.js`:
```javascript
process.env.DEBUG = 'true';
```

## ContribuiÃ§Ã£o

1. Fork o projeto
2. Crie uma branch para sua feature (`git checkout -b feature/nova-feature`)
3. Commit suas mudanÃ§as (`git commit -am 'Adiciona nova feature'`)
4. Push para a branch (`git push origin feature/nova-feature`)
5. Abra um Pull Request

## LicenÃ§a

Este projeto estÃ¡ sob a licenÃ§a MIT. Veja o arquivo `LICENSE` para mais detalhes.

## Suporte

Para suporte tÃ©cnico, entre em contato:
- **Email:** suporte@nomatv.com
- **Discord:** [Servidor NomaTV](https://discord.gg/nomatv)
- **DocumentaÃ§Ã£o:** [Wiki do Projeto](https://github.com/NomaTV/painel-backend-corrigido/wiki)

## Changelog

### v4.5 - [Data Atual]
- âœ¨ Sistema de branding personalizado
- âœ¨ RelatÃ³rios avanÃ§ados
- âœ¨ Controle de rede revendedor
- ğŸ”’ Melhorias de seguranÃ§a
- ğŸ› CorreÃ§Ãµes de bugs

### v4.2 - [Data Anterior]
- ğŸ“Š Dashboard interativo
- ğŸ’° Sistema financeiro completo
- ğŸ‘¥ Hierarquia de revendedores
- ğŸ”„ API RESTful completa

### v4.0 - [LanÃ§amento Inicial]
- ğŸ–¥ï¸ Interface administrativa
- ğŸ“º GestÃ£o de provedores e ativos
- ğŸ” Sistema de autenticaÃ§Ã£o
- ğŸ“± Design responsivo

---

**NomaTV** - Sistema profissional de gerenciamento IPTV ğŸš€